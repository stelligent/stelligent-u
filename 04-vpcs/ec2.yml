AWSTemplateFormatVersion: "2010-09-09"
Description: Module 4 EC2

Parameters:
  ImageIdParam:
    Type: String
    Description: The AMI to use to launch the instance from
  KeyNameParam:
    Type: String
    Description: The name of the keypair to use
  InstanceTypeParam:
    Type: String
    Description: What size instance to use

Resources:
  EC2:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref ImageIdParam
      KeyName: !Ref KeyNameParam
      InstanceType: !Ref InstanceTypeParam
      SecurityGroupIds:
        - !Ref SecurityGroup
      SubnetId: !ImportValue willdeberry-subnet-id
      Tags:
        - Key: Name
          Value: will.deberry-ec2
        - Key: user
          Value: will.deberry.labs
        - Key: stelligent-u-lesson
          Value: 04-vpcs
        - Key: stelligent-u-lab
          Value: 4.1.4
  PrivateEC2:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref ImageIdParam
      KeyName: !Ref KeyNameParam
      InstanceType: !Ref InstanceTypeParam
      SecurityGroupIds:
        - !Ref SecurityGroup
      SubnetId: !ImportValue willdeberry-private-subnet-id
      Tags:
        - Key: Name
          Value: will.deberry-private-ec2
        - Key: user
          Value: will.deberry.labs
        - Key: stelligent-u-lesson
          Value: 04-vpcs
        - Key: stelligent-u-lab
          Value: 4.1.7
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SG to allow ping and ssh
      GroupName: willdeberry-sg
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          Description: Allow icmp
          FromPort: 8
          IpProtocol: icmp
          ToPort: -1
        - CidrIp: 0.0.0.0/0
          Description: Allow ssh
          FromPort: 22
          IpProtocol: tcp
          ToPort: 22
      Tags:
        - Key: Name
          Value: will.deberry-sg
        - Key: user
          Value: will.deberry.labs
        - Key: stelligent-u-lesson
          Value: 04-vpcs
        - Key: stelligent-u-lab
          Value: 4.1.5
      VpcId: !ImportValue willdeberry-vpc-id
  ElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      InstanceId: !Ref EC2
      Tags:
        - Key: Name
          Value: will.deberry-eip
        - Key: user
          Value: will.deberry.labs
        - Key: stelligent-u-lesson
          Value: 04-vpcs
        - Key: stelligent-u-lab
          Value: 4.1.6

Outputs:
  InstanceId:
    Description: ID of the instance
    Value: !Ref EC2
  InstanceIP:
    Description: Private IP of the instance
    Value: !GetAtt EC2.PrivateIp
  PublicIP:
    Description: Public IP of the instance
    Value: !GetAtt EC2.PublicIp
